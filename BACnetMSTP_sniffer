// Waveshare ESP32-C6 1.47" Display Dev Board (ST7789 172x320)
// BACnet MS/TP Passive Scanner + On-screen MAC map (0..127)
// - Green circle = seen recently (online)
// - Grey circle  = was seen before but quiet for OFFLINE_MS
// - No circle    = never seen yet
//
// Requires: Adafruit GFX, Adafruit ST7735 and ST7789 Library

#include <Arduino.h>
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>
#include <SPI.h>

// ---------------- USER OPTIONS ----------------
#define BAUD                38400UL   // MS/TP baud (9600/19200/38400/76800 etc.)
#define REPORT_MS           1000      // Update footer & aging check every 1s
#define FRAME_TIMEOUT_MS    100       // Inter-byte timeout while parsing frames
#define MAX_PAYLOAD         501       // MS/TP payload max per spec
#define OFFLINE_MS          10000UL   // If not seen in this many ms -> "grey/offline"

// UART pins (ESP32-C6 can remap UART pins freely)
#define BUS_UART_RX_PIN     16        // RS-485 RO -> here
#define BUS_UART_TX_PIN     17        // RS-485 DI -> here (unused but must be valid)
#define REDE_PIN            4         // RS-485 RE/DE tied; keep LOW for receive-only

HardwareSerial& BUS = Serial1;        // MS/TP bus
HardwareSerial& CON = Serial;         // USB serial for logs

// -------- DISPLAY PINS / OPTIONS (edit if your board differs) --------
#define TFT_CS   5
#define TFT_DC   6
#define TFT_RST  7
#define TFT_SCLK 8
#define TFT_MOSI 10
#define TFT_ROTATION 1   // 0/1/2/3

// Custom colors (RGB565)
#define COLOR_GREY   0x8410   // mid grey
#define COLOR_GRID   0x4208   // dark grey

Adafruit_ST7789 tft = Adafruit_ST7789(TFT_CS, TFT_DC, TFT_RST);

// ---------------- BACnet MS/TP bits ----------------
const uint8_t PREAMBLE0 = 0x55;
const uint8_t PREAMBLE1 = 0xFF;

const uint8_t FRAME_TOKEN
